<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz Question Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: { 50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd', 300: '#7dd3fc', 400: '#38bdf8', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 800: '#075985', 900: '#0c4a6e' },
          }
        }
      }
    }
  </script>
  <style>
    .gradient-border {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .card-gradient {
      background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
    }
    .animate-pulse-slow {
      animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @keyframes slideIn {
      from { transform: translateY(-10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .slide-in {
      animation: slideIn 0.3s ease-out;
    }
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
    }
    .scrollbar-thin::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.3);
      border-radius: 3px;
    }
  </style>
</head>
<body class="h-full">
  <div id="app" class="min-h-full">
    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700 sticky top-0 z-40">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl gradient-border flex items-center justify-center">
              <span class="text-xl">üéØ</span>
            </div>
            <div>
              <h1 class="text-xl font-bold text-white">Quiz Generator</h1>
              <p class="text-xs text-gray-400">Universal Question Generation System</p>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <button onclick="openBulkModal()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-gray-200 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
              Bulk Generate
            </button>
            <button onclick="openModal()" class="px-4 py-2 bg-primary-600 hover:bg-primary-500 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
              Generate Questions
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Stats Cards -->
      <div id="stats-section" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-400 text-sm">Total Topics</p>
              <p id="stat-topics" class="text-2xl font-bold text-white mt-1">-</p>
            </div>
            <div class="w-12 h-12 rounded-xl bg-blue-500/20 flex items-center justify-center">
              <span class="text-2xl">üìö</span>
            </div>
          </div>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-400 text-sm">Topics Generated</p>
              <p id="stat-generated" class="text-2xl font-bold text-white mt-1">-</p>
            </div>
            <div class="w-12 h-12 rounded-xl bg-green-500/20 flex items-center justify-center">
              <span class="text-2xl">‚úÖ</span>
            </div>
          </div>
          <div class="mt-3">
            <div class="w-full bg-gray-700 rounded-full h-2">
              <div id="stat-progress" class="bg-green-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
          </div>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-400 text-sm">Total Questions</p>
              <p id="stat-questions" class="text-2xl font-bold text-white mt-1">-</p>
            </div>
            <div class="w-12 h-12 rounded-xl bg-purple-500/20 flex items-center justify-center">
              <span class="text-2xl">‚ùì</span>
            </div>
          </div>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-400 text-sm">Categories</p>
              <p id="stat-categories" class="text-2xl font-bold text-white mt-1">-</p>
            </div>
            <div class="w-12 h-12 rounded-xl bg-orange-500/20 flex items-center justify-center">
              <span class="text-2xl">üóÇÔ∏è</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Depth Distribution -->
      <div class="bg-gray-800 rounded-xl p-5 border border-gray-700 mb-8">
        <h2 class="text-lg font-semibold text-white mb-4">Depth Distribution</h2>
        <div class="grid grid-cols-5 gap-3">
          <div class="text-center">
            <div class="text-2xl font-bold text-red-400" id="depth-limited">-</div>
            <div class="text-xs text-gray-400 mt-1">Limited</div>
            <div class="text-xs text-gray-500">~1K Q</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-orange-400" id="depth-medium">-</div>
            <div class="text-xs text-gray-400 mt-1">Medium</div>
            <div class="text-xs text-gray-500">~2K Q</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-yellow-400" id="depth-large">-</div>
            <div class="text-xs text-gray-400 mt-1">Large</div>
            <div class="text-xs text-gray-500">~4K Q</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-green-400" id="depth-massive">-</div>
            <div class="text-xs text-gray-400 mt-1">Massive</div>
            <div class="text-xs text-gray-500">~7.5K Q</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-blue-400" id="depth-immense">-</div>
            <div class="text-xs text-gray-400 mt-1">Immense</div>
            <div class="text-xs text-gray-500">~12K Q</div>
          </div>
        </div>
      </div>

      <!-- Two Column Layout -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Category Breakdown -->
        <div class="lg:col-span-2">
          <div class="bg-gray-800 rounded-xl border border-gray-700">
            <div class="px-5 py-4 border-b border-gray-700 flex items-center justify-between">
              <h2 class="text-lg font-semibold text-white">Categories</h2>
              <div class="flex items-center gap-2">
                <input type="text" id="search-input" placeholder="Search topics..."
                  class="px-3 py-1.5 bg-gray-700 border border-gray-600 rounded-lg text-sm text-white placeholder-gray-400 focus:outline-none focus:border-primary-500 w-48">
              </div>
            </div>
            <div id="categories-list" class="divide-y divide-gray-700 max-h-96 overflow-y-auto scrollbar-thin">
              <!-- Categories will be injected here -->
            </div>
          </div>
        </div>

        <!-- Recently Generated -->
        <div>
          <div class="bg-gray-800 rounded-xl border border-gray-700">
            <div class="px-5 py-4 border-b border-gray-700">
              <h2 class="text-lg font-semibold text-white">Recently Generated</h2>
            </div>
            <div id="recent-list" class="divide-y divide-gray-700 max-h-96 overflow-y-auto scrollbar-thin">
              <!-- Recent items will be injected here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Topics Table -->
      <div class="mt-8 bg-gray-800 rounded-xl border border-gray-700">
        <div class="px-5 py-4 border-b border-gray-700 flex items-center justify-between">
          <h2 class="text-lg font-semibold text-white">All Topics</h2>
          <div class="flex items-center gap-3">
            <select id="filter-category" class="px-3 py-1.5 bg-gray-700 border border-gray-600 rounded-lg text-sm text-white focus:outline-none focus:border-primary-500">
              <option value="">All Categories</option>
            </select>
            <select id="filter-status" class="px-3 py-1.5 bg-gray-700 border border-gray-600 rounded-lg text-sm text-white focus:outline-none focus:border-primary-500">
              <option value="">All Status</option>
              <option value="generated">Generated</option>
              <option value="pending">Pending</option>
            </select>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-700/50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Topic</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Category</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Depth</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Questions</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
                <th class="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">Action</th>
              </tr>
            </thead>
            <tbody id="topics-table" class="divide-y divide-gray-700">
              <!-- Topics will be injected here -->
            </tbody>
          </table>
        </div>
        <div id="topics-pagination" class="px-5 py-3 border-t border-gray-700 flex items-center justify-between">
          <p class="text-sm text-gray-400">Showing <span id="showing-count">0</span> of <span id="total-count">0</span> topics</p>
          <div class="flex gap-2">
            <button onclick="prevPage()" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded text-sm disabled:opacity-50">Previous</button>
            <button onclick="nextPage()" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded text-sm disabled:opacity-50">Next</button>
          </div>
        </div>
      </div>
    </main>

    <!-- Generate Modal -->
    <div id="generate-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
      <div class="bg-gray-800 rounded-2xl border border-gray-700 w-full max-w-lg slide-in">
        <div class="px-6 py-4 border-b border-gray-700 flex items-center justify-between">
          <h3 class="text-lg font-semibold text-white">Generate Questions</h3>
          <button onclick="closeModal()" class="text-gray-400 hover:text-white">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
          </button>
        </div>

        <div id="modal-form" class="p-6 space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Category</label>
            <select id="modal-category" onchange="onCategoryChange()" class="w-full px-4 py-2.5 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-primary-500">
              <option value="">Select a category...</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Subcategory</label>
            <select id="modal-subcategory" onchange="onSubcategoryChange()" disabled class="w-full px-4 py-2.5 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-primary-500 disabled:opacity-50">
              <option value="">Select a subcategory...</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Topic</label>
            <select id="modal-topic" onchange="onTopicChange()" disabled class="w-full px-4 py-2.5 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-primary-500 disabled:opacity-50">
              <option value="">Select a topic...</option>
            </select>
          </div>

          <!-- TV Show Season/Episode (only visible for tv-shows) -->
          <div id="tv-show-options" class="hidden space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Season</label>
                <select id="modal-season" onchange="onSeasonChange()" class="w-full px-4 py-2.5 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-primary-500">
                  <option value="">Select season...</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Episode</label>
                <select id="modal-episode" onchange="onEpisodeChange()" disabled class="w-full px-4 py-2.5 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-primary-500 disabled:opacity-50">
                  <option value="">Select episode...</option>
                </select>
              </div>
            </div>

            <!-- Transcript Status -->
            <div id="transcript-status" class="hidden">
              <div id="transcript-missing" class="hidden bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
                <div class="flex items-start gap-3">
                  <svg class="w-5 h-5 text-yellow-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                  </svg>
                  <div class="flex-1">
                    <p class="text-yellow-400 font-medium">No transcript found</p>
                    <p class="text-yellow-400/70 text-sm mt-1">You need to scrape the transcript before generating questions.</p>
                  </div>
                </div>
                <button id="scrape-transcript-btn" onclick="scrapeTranscript()" class="w-full mt-3 py-2 bg-yellow-600 hover:bg-yellow-500 text-white font-medium rounded-lg transition-colors flex items-center justify-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                  Scrape Transcript
                </button>
              </div>
              <div id="transcript-exists" class="hidden bg-green-500/10 border border-green-500/30 rounded-lg p-4">
                <div class="flex items-start gap-3">
                  <svg class="w-5 h-5 text-green-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                  <div>
                    <p class="text-green-400 font-medium">Transcript available</p>
                    <p id="transcript-info" class="text-green-400/70 text-sm mt-1"></p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Topic Info -->
          <div id="topic-info" class="hidden bg-gray-700/50 rounded-lg p-4">
            <div class="grid grid-cols-2 gap-4 text-sm">
              <div>
                <p class="text-gray-400">Depth</p>
                <p id="info-depth" class="text-white font-medium">-</p>
              </div>
              <div>
                <p class="text-gray-400">Target Questions</p>
                <p id="info-target" class="text-white font-medium">-</p>
              </div>
              <div>
                <p class="text-gray-400">Current Questions</p>
                <p id="info-current" class="text-white font-medium">-</p>
              </div>
              <div>
                <p class="text-gray-400">To Generate</p>
                <p id="info-to-generate" class="text-white font-medium">-</p>
              </div>
            </div>
          </div>

          <button id="generate-btn" onclick="startGeneration()" disabled class="w-full py-3 bg-primary-600 hover:bg-primary-500 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-medium rounded-lg transition-colors">
            Generate Questions
          </button>
        </div>

        <!-- Progress View -->
        <div id="modal-progress" class="p-6 hidden">
          <div class="text-center mb-6">
            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-primary-500/20 flex items-center justify-center">
              <svg id="progress-spinner" class="w-8 h-8 text-primary-500 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <svg id="progress-success" class="w-8 h-8 text-green-500 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
              <svg id="progress-error" class="w-8 h-8 text-red-500 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </div>
            <h4 id="progress-title" class="text-lg font-medium text-white">Generating...</h4>
            <p id="progress-status" class="text-sm text-gray-400 mt-1">Initializing...</p>
          </div>

          <!-- Progress Steps -->
          <div class="space-y-3 mb-6">
            <div class="flex items-center gap-3">
              <div id="step-1" class="w-6 h-6 rounded-full bg-gray-600 flex items-center justify-center text-xs text-gray-400">1</div>
              <span class="text-sm text-gray-400">Initialize</span>
            </div>
            <div class="flex items-center gap-3">
              <div id="step-2" class="w-6 h-6 rounded-full bg-gray-600 flex items-center justify-center text-xs text-gray-400">2</div>
              <span class="text-sm text-gray-400">Fetch Content</span>
            </div>
            <div class="flex items-center gap-3">
              <div id="step-3" class="w-6 h-6 rounded-full bg-gray-600 flex items-center justify-center text-xs text-gray-400">3</div>
              <span class="text-sm text-gray-400">Build Prompt</span>
            </div>
            <div class="flex items-center gap-3">
              <div id="step-4" class="w-6 h-6 rounded-full bg-gray-600 flex items-center justify-center text-xs text-gray-400">4</div>
              <span class="text-sm text-gray-400">Generate with AI</span>
            </div>
            <div class="flex items-center gap-3">
              <div id="step-5" class="w-6 h-6 rounded-full bg-gray-600 flex items-center justify-center text-xs text-gray-400">5</div>
              <span class="text-sm text-gray-400">Save Questions</span>
            </div>
          </div>

          <!-- Log -->
          <div class="bg-gray-900 rounded-lg p-3 max-h-32 overflow-y-auto scrollbar-thin">
            <div id="progress-log" class="text-xs font-mono text-gray-400 space-y-1">
            </div>
          </div>

          <button id="close-progress-btn" onclick="closeModal()" class="w-full mt-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg hidden">
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Bulk Generate Modal -->
    <div id="bulk-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
      <div class="bg-gray-800 rounded-2xl border border-gray-700 w-full max-w-2xl slide-in">
        <div class="px-6 py-4 border-b border-gray-700 flex items-center justify-between">
          <h3 class="text-lg font-semibold text-white">Bulk Generate Questions</h3>
          <button onclick="closeBulkModal()" class="text-gray-400 hover:text-white">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
          </button>
        </div>

        <div id="bulk-form" class="p-6 space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Category</label>
              <select id="bulk-category" onchange="onBulkCategoryChange()" class="w-full px-4 py-2.5 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-primary-500">
                <option value="">All Categories</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Depth Filter</label>
              <select id="bulk-depth" class="w-full px-4 py-2.5 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-primary-500">
                <option value="">All Depths</option>
                <option value="immense">Immense only</option>
                <option value="massive">Massive & above</option>
                <option value="large">Large & above</option>
              </select>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Status Filter</label>
            <select id="bulk-status" class="w-full px-4 py-2.5 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-primary-500">
              <option value="incomplete">Incomplete (below target)</option>
              <option value="pending">Not started</option>
              <option value="all">All topics</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Max Topics to Process</label>
            <input type="number" id="bulk-limit" value="10" min="1" max="100" class="w-full px-4 py-2.5 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-primary-500">
          </div>

          <div id="bulk-preview" class="bg-gray-700/50 rounded-lg p-4 text-sm text-gray-300">
            <p>Select filters to preview topics...</p>
          </div>

          <button id="bulk-start-btn" onclick="startBulkGeneration()" class="w-full py-3 bg-primary-600 hover:bg-primary-500 text-white font-medium rounded-lg transition-colors">
            Start Bulk Generation
          </button>
        </div>

        <!-- Bulk Progress -->
        <div id="bulk-progress" class="p-6 hidden">
          <div class="mb-4">
            <div class="flex justify-between text-sm mb-2">
              <span class="text-gray-400">Progress</span>
              <span id="bulk-progress-text" class="text-white">0 / 0</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-3">
              <div id="bulk-progress-bar" class="bg-primary-500 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
          </div>

          <div id="bulk-log" class="bg-gray-900 rounded-lg p-3 max-h-64 overflow-y-auto scrollbar-thin text-xs font-mono text-gray-400 space-y-1">
          </div>

          <button id="bulk-close-btn" onclick="closeBulkModal()" class="w-full mt-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg hidden">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // State
    let registry = null;
    let allTopics = [];
    let filteredTopics = [];
    let currentPage = 0;
    const pageSize = 20;
    let tvShows = [];
    let currentTVShow = null;
    let transcriptAvailable = false;

    const DEPTH_TARGETS = {
      limited: 30,
      medium: 75,
      large: 150,
      massive: 350,
      immense: 750,
    };

    const DEPTH_COLORS = {
      limited: 'text-red-400',
      medium: 'text-orange-400',
      large: 'text-yellow-400',
      massive: 'text-green-400',
      immense: 'text-blue-400',
    };

    // Initialize
    async function init() {
      await Promise.all([
        loadStats(),
        loadRegistry(),
        loadTopics(),
        loadRecent(),
        loadTVShows(),
      ]);
      setupEventListeners();
    }

    async function loadTVShows() {
      const res = await fetch('/api/tv-shows');
      tvShows = await res.json();
    }

    async function loadStats() {
      const res = await fetch('/api/stats');
      const stats = await res.json();

      document.getElementById('stat-topics').textContent = stats.totalTopics.toLocaleString();
      document.getElementById('stat-generated').textContent = stats.totalGenerated.toLocaleString();
      document.getElementById('stat-questions').textContent = stats.totalQuestions.toLocaleString();
      document.getElementById('stat-categories').textContent = Object.keys(stats.byCategory).length;

      const progress = (stats.totalGenerated / stats.totalTopics * 100).toFixed(1);
      document.getElementById('stat-progress').style.width = progress + '%';

      // Depth distribution
      document.getElementById('depth-limited').textContent = stats.byDepth.limited;
      document.getElementById('depth-medium').textContent = stats.byDepth.medium;
      document.getElementById('depth-large').textContent = stats.byDepth.large;
      document.getElementById('depth-massive').textContent = stats.byDepth.massive;
      document.getElementById('depth-immense').textContent = stats.byDepth.immense;

      // Categories list
      const catList = document.getElementById('categories-list');
      catList.innerHTML = Object.entries(stats.byCategory).map(([key, cat]) => `
        <div class="px-5 py-3 flex items-center justify-between hover:bg-gray-700/50 cursor-pointer" onclick="filterByCategory('${key}')">
          <div>
            <p class="text-white font-medium">${key.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</p>
            <p class="text-xs text-gray-400">${cat.total} topics</p>
          </div>
          <div class="text-right">
            <p class="text-white">${cat.questions.toLocaleString()} Q</p>
            <p class="text-xs text-gray-400">${cat.generated}/${cat.total} done</p>
          </div>
        </div>
      `).join('');

      // Populate filter dropdown
      const filterCat = document.getElementById('filter-category');
      filterCat.innerHTML = '<option value="">All Categories</option>' +
        Object.keys(stats.byCategory).map(key => `<option value="${key}">${key}</option>`).join('');
    }

    async function loadRegistry() {
      const res = await fetch('/api/registry');
      registry = await res.json();

      // Populate modal dropdowns
      const catSelect = document.getElementById('modal-category');
      catSelect.innerHTML = '<option value="">Select a category...</option>' +
        Object.entries(registry.categories).map(([key, cat]) =>
          `<option value="${key}">${cat.name}</option>`
        ).join('');

      // Bulk modal
      const bulkCat = document.getElementById('bulk-category');
      bulkCat.innerHTML = '<option value="">All Categories</option>' +
        Object.entries(registry.categories).map(([key, cat]) =>
          `<option value="${key}">${cat.name}</option>`
        ).join('');
    }

    async function loadTopics() {
      const res = await fetch('/api/topics');
      allTopics = await res.json();
      filteredTopics = [...allTopics];
      renderTopicsTable();
    }

    async function loadRecent() {
      const res = await fetch('/api/recent?limit=10');
      const recent = await res.json();

      const recentList = document.getElementById('recent-list');
      if (recent.length === 0) {
        recentList.innerHTML = '<div class="px-5 py-8 text-center text-gray-400">No questions generated yet</div>';
        return;
      }

      recentList.innerHTML = recent.map(t => `
        <div class="px-5 py-3 hover:bg-gray-700/50">
          <div class="flex items-center justify-between">
            <p class="text-white font-medium text-sm">${t.name}</p>
            <span class="text-xs text-gray-400">${t.questionCount} Q</span>
          </div>
          <p class="text-xs text-gray-500 mt-1">${t.categoryName} / ${t.subcategoryName}</p>
          <p class="text-xs text-gray-500">${new Date(t.generatedAt).toLocaleDateString()}</p>
        </div>
      `).join('');
    }

    function renderTopicsTable() {
      const start = currentPage * pageSize;
      const end = start + pageSize;
      const pageTopics = filteredTopics.slice(start, end);

      const tbody = document.getElementById('topics-table');
      tbody.innerHTML = pageTopics.map(t => {
        const progress = t.questionCount / t.targetCount * 100;
        const status = t.questionCount === 0 ? 'pending' : (progress >= 100 ? 'complete' : 'partial');
        const statusBadge = {
          pending: '<span class="px-2 py-1 text-xs rounded-full bg-gray-600 text-gray-300">Pending</span>',
          partial: '<span class="px-2 py-1 text-xs rounded-full bg-yellow-500/20 text-yellow-400">Partial</span>',
          complete: '<span class="px-2 py-1 text-xs rounded-full bg-green-500/20 text-green-400">Complete</span>',
        };

        return `
          <tr class="hover:bg-gray-700/50">
            <td class="px-4 py-3">
              <p class="text-white font-medium">${t.name}</p>
              <p class="text-xs text-gray-500">${t.topic}</p>
            </td>
            <td class="px-4 py-3">
              <p class="text-gray-300 text-sm">${t.categoryName}</p>
              <p class="text-xs text-gray-500">${t.subcategoryName}</p>
            </td>
            <td class="px-4 py-3">
              <span class="${DEPTH_COLORS[t.depth]} font-medium text-sm">${t.depth}</span>
            </td>
            <td class="px-4 py-3">
              <p class="text-white text-sm">${t.questionCount} / ${t.targetCount}</p>
              <div class="w-24 bg-gray-700 rounded-full h-1.5 mt-1">
                <div class="bg-primary-500 h-1.5 rounded-full" style="width: ${Math.min(progress, 100)}%"></div>
              </div>
            </td>
            <td class="px-4 py-3">${statusBadge[status]}</td>
            <td class="px-4 py-3 text-right">
              <button onclick="generateSingle('${t.category}', '${t.subcategory}', '${t.topic}')"
                class="px-3 py-1 text-xs bg-primary-600 hover:bg-primary-500 text-white rounded-lg">
                Generate
              </button>
            </td>
          </tr>
        `;
      }).join('');

      document.getElementById('showing-count').textContent = pageTopics.length;
      document.getElementById('total-count').textContent = filteredTopics.length;
    }

    function filterByCategory(cat) {
      document.getElementById('filter-category').value = cat;
      applyFilters();
    }

    function applyFilters() {
      const catFilter = document.getElementById('filter-category').value;
      const statusFilter = document.getElementById('filter-status').value;
      const search = document.getElementById('search-input').value.toLowerCase();

      filteredTopics = allTopics.filter(t => {
        if (catFilter && t.category !== catFilter) return false;
        if (statusFilter === 'generated' && t.questionCount === 0) return false;
        if (statusFilter === 'pending' && t.questionCount > 0) return false;
        if (search && !t.name.toLowerCase().includes(search) && !t.topic.toLowerCase().includes(search)) return false;
        return true;
      });

      currentPage = 0;
      renderTopicsTable();
    }

    function setupEventListeners() {
      document.getElementById('filter-category').addEventListener('change', applyFilters);
      document.getElementById('filter-status').addEventListener('change', applyFilters);
      document.getElementById('search-input').addEventListener('input', applyFilters);

      // Bulk filters
      document.getElementById('bulk-category').addEventListener('change', updateBulkPreview);
      document.getElementById('bulk-depth').addEventListener('change', updateBulkPreview);
      document.getElementById('bulk-status').addEventListener('change', updateBulkPreview);
      document.getElementById('bulk-limit').addEventListener('change', updateBulkPreview);
    }

    function prevPage() {
      if (currentPage > 0) {
        currentPage--;
        renderTopicsTable();
      }
    }

    function nextPage() {
      if ((currentPage + 1) * pageSize < filteredTopics.length) {
        currentPage++;
        renderTopicsTable();
      }
    }

    // Modal Functions
    function openModal() {
      document.getElementById('generate-modal').classList.remove('hidden');
      document.getElementById('modal-form').classList.remove('hidden');
      document.getElementById('modal-progress').classList.add('hidden');
      resetModalForm();
    }

    function closeModal() {
      document.getElementById('generate-modal').classList.add('hidden');
      loadStats();
      loadTopics();
      loadRecent();
    }

    function resetModalForm() {
      document.getElementById('modal-category').value = '';
      document.getElementById('modal-subcategory').value = '';
      document.getElementById('modal-subcategory').disabled = true;
      document.getElementById('modal-topic').value = '';
      document.getElementById('modal-topic').disabled = true;
      document.getElementById('topic-info').classList.add('hidden');
      document.getElementById('generate-btn').disabled = true;

      // Reset TV show options
      document.getElementById('tv-show-options').classList.add('hidden');
      document.getElementById('transcript-status').classList.add('hidden');
      document.getElementById('modal-season').value = '';
      document.getElementById('modal-episode').value = '';
      document.getElementById('modal-episode').disabled = true;
      currentTVShow = null;
      transcriptAvailable = false;
    }

    function onCategoryChange() {
      const cat = document.getElementById('modal-category').value;
      const subSelect = document.getElementById('modal-subcategory');
      const topicSelect = document.getElementById('modal-topic');

      if (!cat) {
        subSelect.disabled = true;
        subSelect.innerHTML = '<option value="">Select a subcategory...</option>';
        topicSelect.disabled = true;
        topicSelect.innerHTML = '<option value="">Select a topic...</option>';
        document.getElementById('topic-info').classList.add('hidden');
        document.getElementById('generate-btn').disabled = true;
        return;
      }

      const subs = registry.categories[cat].subcategories;
      subSelect.disabled = false;
      subSelect.innerHTML = '<option value="">Select a subcategory...</option>' +
        Object.entries(subs).map(([key, sub]) =>
          `<option value="${key}">${sub.name}</option>`
        ).join('');

      topicSelect.disabled = true;
      topicSelect.innerHTML = '<option value="">Select a topic...</option>';
      document.getElementById('topic-info').classList.add('hidden');
      document.getElementById('generate-btn').disabled = true;
    }

    function onSubcategoryChange() {
      const cat = document.getElementById('modal-category').value;
      const sub = document.getElementById('modal-subcategory').value;
      const topicSelect = document.getElementById('modal-topic');

      if (!sub) {
        topicSelect.disabled = true;
        topicSelect.innerHTML = '<option value="">Select a topic...</option>';
        document.getElementById('topic-info').classList.add('hidden');
        document.getElementById('generate-btn').disabled = true;
        return;
      }

      const topics = registry.categories[cat].subcategories[sub].topics;
      topicSelect.disabled = false;
      topicSelect.innerHTML = '<option value="">Select a topic...</option>' +
        Object.entries(topics).map(([key, topic]) =>
          `<option value="${key}">${topic.name}</option>`
        ).join('');

      document.getElementById('topic-info').classList.add('hidden');
      document.getElementById('generate-btn').disabled = true;
    }

    function onTopicChange() {
      const cat = document.getElementById('modal-category').value;
      const sub = document.getElementById('modal-subcategory').value;
      const topicKey = document.getElementById('modal-topic').value;

      // Reset TV show options
      document.getElementById('tv-show-options').classList.add('hidden');
      document.getElementById('transcript-status').classList.add('hidden');
      currentTVShow = null;
      transcriptAvailable = false;

      if (!topicKey) {
        document.getElementById('topic-info').classList.add('hidden');
        document.getElementById('generate-btn').disabled = true;
        return;
      }

      const topic = registry.categories[cat].subcategories[sub].topics[topicKey];
      const existing = allTopics.find(t => t.topic === topicKey);
      const depth = topic.depth || 'medium';
      const target = DEPTH_TARGETS[depth];
      const current = existing?.questionCount || 0;

      document.getElementById('info-depth').textContent = depth;
      document.getElementById('info-depth').className = `font-medium ${DEPTH_COLORS[depth]}`;
      document.getElementById('info-target').textContent = target;
      document.getElementById('info-current').textContent = current;
      document.getElementById('info-to-generate').textContent = Math.max(0, target - current);

      document.getElementById('topic-info').classList.remove('hidden');

      // Check if this is a TV show
      if (cat === 'tv-shows') {
        currentTVShow = tvShows.find(s => s.slug === topicKey);
        if (currentTVShow) {
          document.getElementById('tv-show-options').classList.remove('hidden');

          // Populate seasons (allow manual entry for new shows)
          const seasonSelect = document.getElementById('modal-season');
          const existingSeasons = currentTVShow.seasons || [];

          // If no seasons exist, show 1-10 as options for new shows
          const seasonsToShow = existingSeasons.length > 0 ? existingSeasons : [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
          seasonSelect.innerHTML = '<option value="">Select season...</option>' +
            seasonsToShow.map(s => `<option value="${s}">Season ${s}</option>`).join('');

          document.getElementById('modal-episode').innerHTML = '<option value="">Select episode...</option>';
          document.getElementById('modal-episode').disabled = true;

          // Don't enable generate button until episode is selected
          document.getElementById('generate-btn').disabled = true;
          return;
        }
      }

      document.getElementById('generate-btn').disabled = false;
    }

    async function onSeasonChange() {
      const season = document.getElementById('modal-season').value;
      const episodeSelect = document.getElementById('modal-episode');

      document.getElementById('transcript-status').classList.add('hidden');
      document.getElementById('generate-btn').disabled = true;
      transcriptAvailable = false;

      if (!season || !currentTVShow) {
        episodeSelect.disabled = true;
        episodeSelect.innerHTML = '<option value="">Select episode...</option>';
        return;
      }

      episodeSelect.disabled = false;

      // Fetch episodes for this season
      try {
        const res = await fetch(`/api/tv-shows/${currentTVShow.slug}/seasons/${season}/episodes`);
        const episodes = await res.json();

        if (episodes.length > 0) {
          episodeSelect.innerHTML = '<option value="">Select episode...</option>' +
            episodes.map(e => `<option value="${e.episode}">${e.episode}. ${e.title}${e.hasTranscript ? ' ‚úì' : ''}</option>`).join('');
        } else {
          // No episodes yet, show 1-24 as options
          episodeSelect.innerHTML = '<option value="">Select episode...</option>' +
            Array.from({length: 24}, (_, i) => i + 1).map(n => `<option value="${n}">Episode ${n}</option>`).join('');
        }
      } catch (e) {
        // Fallback to manual episode numbers
        episodeSelect.innerHTML = '<option value="">Select episode...</option>' +
          Array.from({length: 24}, (_, i) => i + 1).map(n => `<option value="${n}">Episode ${n}</option>`).join('');
      }
    }

    async function onEpisodeChange() {
      const season = document.getElementById('modal-season').value;
      const episode = document.getElementById('modal-episode').value;

      document.getElementById('transcript-status').classList.add('hidden');
      document.getElementById('transcript-missing').classList.add('hidden');
      document.getElementById('transcript-exists').classList.add('hidden');
      document.getElementById('generate-btn').disabled = true;
      transcriptAvailable = false;

      if (!season || !episode || !currentTVShow) {
        return;
      }

      // Check transcript status
      try {
        const res = await fetch(`/api/transcript-status?show=${currentTVShow.slug}&season=${season}&episode=${episode}`);
        const status = await res.json();

        document.getElementById('transcript-status').classList.remove('hidden');

        if (status.exists) {
          document.getElementById('transcript-exists').classList.remove('hidden');
          document.getElementById('transcript-info').textContent =
            `"${status.title}" - ${status.wordCount.toLocaleString()} words (${status.source})`;
          document.getElementById('generate-btn').disabled = false;
          transcriptAvailable = true;
        } else {
          document.getElementById('transcript-missing').classList.remove('hidden');
          transcriptAvailable = false;
        }
      } catch (e) {
        document.getElementById('transcript-status').classList.remove('hidden');
        document.getElementById('transcript-missing').classList.remove('hidden');
        transcriptAvailable = false;
      }
    }

    async function scrapeTranscript() {
      const season = parseInt(document.getElementById('modal-season').value);
      const episode = parseInt(document.getElementById('modal-episode').value);

      if (!currentTVShow || !season || !episode) return;

      const btn = document.getElementById('scrape-transcript-btn');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Scraping...';

      try {
        const res = await fetch('/api/scrape-transcript', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            show: currentTVShow.slug,
            showName: currentTVShow.name,
            season,
            episode,
          }),
        });

        const result = await res.json();

        if (result.error) {
          alert('Failed to scrape transcript: ' + result.error);
          btn.innerHTML = originalText;
          btn.disabled = false;
          return;
        }

        // Refresh transcript status
        await onEpisodeChange();
      } catch (e) {
        alert('Failed to scrape transcript: ' + e.message);
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }

    function generateSingle(category, subcategory, topic) {
      document.getElementById('modal-category').value = category;
      onCategoryChange();
      setTimeout(() => {
        document.getElementById('modal-subcategory').value = subcategory;
        onSubcategoryChange();
        setTimeout(() => {
          document.getElementById('modal-topic').value = topic;
          onTopicChange();
          openModal();
        }, 50);
      }, 50);
    }

    async function startGeneration() {
      const category = document.getElementById('modal-category').value;
      const subcategory = document.getElementById('modal-subcategory').value;
      const topic = document.getElementById('modal-topic').value;

      // For TV shows, include season and episode
      let season = null;
      let episode = null;
      if (category === 'tv-shows' && currentTVShow) {
        season = parseInt(document.getElementById('modal-season').value);
        episode = parseInt(document.getElementById('modal-episode').value);

        if (!transcriptAvailable) {
          alert('Please scrape the transcript first before generating questions.');
          return;
        }
      }

      document.getElementById('modal-form').classList.add('hidden');
      document.getElementById('modal-progress').classList.remove('hidden');

      // Reset progress UI
      for (let i = 1; i <= 5; i++) {
        document.getElementById(`step-${i}`).className = 'w-6 h-6 rounded-full bg-gray-600 flex items-center justify-center text-xs text-gray-400';
      }
      document.getElementById('progress-spinner').classList.remove('hidden');
      document.getElementById('progress-success').classList.add('hidden');
      document.getElementById('progress-error').classList.add('hidden');
      document.getElementById('progress-log').innerHTML = '';
      document.getElementById('close-progress-btn').classList.add('hidden');

      try {
        const body = { category, subcategory, topic };
        if (season && episode) {
          body.season = season;
          body.episode = episode;
        }

        const response = await fetch('/api/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const text = decoder.decode(value);
          const lines = text.split('\n').filter(l => l.startsWith('data: '));

          for (const line of lines) {
            const data = JSON.parse(line.slice(6));
            handleProgressEvent(data);
          }
        }
      } catch (error) {
        handleProgressEvent({ type: 'error', message: error.message });
      }
    }

    function handleProgressEvent(event) {
      const log = document.getElementById('progress-log');

      if (event.type === 'status') {
        document.getElementById('progress-status').textContent = event.message;
        log.innerHTML += `<div class="text-primary-400">${event.message}</div>`;

        // Update steps
        if (event.step) {
          for (let i = 1; i < event.step; i++) {
            document.getElementById(`step-${i}`).className = 'w-6 h-6 rounded-full bg-green-500 flex items-center justify-center text-xs text-white';
          }
          document.getElementById(`step-${event.step}`).className = 'w-6 h-6 rounded-full bg-primary-500 flex items-center justify-center text-xs text-white animate-pulse';
        }
      } else if (event.type === 'info') {
        log.innerHTML += `<div class="text-gray-400">${event.message}</div>`;
      } else if (event.type === 'complete') {
        document.getElementById('progress-title').textContent = 'Complete!';
        document.getElementById('progress-status').textContent = event.message;
        document.getElementById('progress-spinner').classList.add('hidden');
        document.getElementById('progress-success').classList.remove('hidden');
        log.innerHTML += `<div class="text-green-400">${event.message}</div>`;

        for (let i = 1; i <= 5; i++) {
          document.getElementById(`step-${i}`).className = 'w-6 h-6 rounded-full bg-green-500 flex items-center justify-center text-xs text-white';
        }

        document.getElementById('close-progress-btn').classList.remove('hidden');
      } else if (event.type === 'error') {
        document.getElementById('progress-title').textContent = 'Error';
        document.getElementById('progress-status').textContent = event.message;
        document.getElementById('progress-spinner').classList.add('hidden');
        document.getElementById('progress-error').classList.remove('hidden');
        log.innerHTML += `<div class="text-red-400">${event.message}</div>`;
        document.getElementById('close-progress-btn').classList.remove('hidden');
      }

      log.scrollTop = log.scrollHeight;
    }

    // Bulk Modal
    function openBulkModal() {
      document.getElementById('bulk-modal').classList.remove('hidden');
      document.getElementById('bulk-form').classList.remove('hidden');
      document.getElementById('bulk-progress').classList.add('hidden');
      updateBulkPreview();
    }

    function closeBulkModal() {
      document.getElementById('bulk-modal').classList.add('hidden');
      loadStats();
      loadTopics();
      loadRecent();
    }

    function onBulkCategoryChange() {
      updateBulkPreview();
    }

    function getBulkTopics() {
      const cat = document.getElementById('bulk-category').value;
      const depth = document.getElementById('bulk-depth').value;
      const status = document.getElementById('bulk-status').value;
      const limit = parseInt(document.getElementById('bulk-limit').value) || 10;

      const depthOrder = ['immense', 'massive', 'large', 'medium', 'limited'];

      let topics = allTopics.filter(t => {
        if (cat && t.category !== cat) return false;
        if (depth) {
          const depthIndex = depthOrder.indexOf(t.depth);
          const filterIndex = depthOrder.indexOf(depth);
          if (depthIndex > filterIndex) return false;
        }
        if (status === 'pending' && t.questionCount > 0) return false;
        if (status === 'incomplete' && t.questionCount >= t.targetCount) return false;
        return true;
      });

      // Sort by depth (immense first)
      topics.sort((a, b) => depthOrder.indexOf(a.depth) - depthOrder.indexOf(b.depth));

      return topics.slice(0, limit);
    }

    function updateBulkPreview() {
      const topics = getBulkTopics();
      const preview = document.getElementById('bulk-preview');

      if (topics.length === 0) {
        preview.innerHTML = '<p class="text-gray-400">No topics match the selected filters</p>';
        return;
      }

      preview.innerHTML = `
        <p class="text-white font-medium mb-2">${topics.length} topics will be processed:</p>
        <div class="max-h-32 overflow-y-auto scrollbar-thin space-y-1">
          ${topics.map(t => `
            <div class="flex items-center justify-between text-xs">
              <span class="text-gray-300">${t.name}</span>
              <span class="${DEPTH_COLORS[t.depth]}">${t.depth}</span>
            </div>
          `).join('')}
        </div>
      `;
    }

    async function startBulkGeneration() {
      const cat = document.getElementById('bulk-category').value;
      const depth = document.getElementById('bulk-depth').value;
      const status = document.getElementById('bulk-status').value;
      const limit = parseInt(document.getElementById('bulk-limit').value) || 10;

      document.getElementById('bulk-form').classList.add('hidden');
      document.getElementById('bulk-progress').classList.remove('hidden');
      document.getElementById('bulk-close-btn').classList.add('hidden');

      const log = document.getElementById('bulk-log');
      log.innerHTML = '<div class="text-gray-400">Connecting to server...</div>';

      let totalTopics = 0;
      let currentIndex = 0;

      try {
        const response = await fetch('/api/bulk-generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ category: cat, depth, status, limit }),
        });

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error || 'Failed to start bulk generation');
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const text = decoder.decode(value);
          const lines = text.split('\n').filter(l => l.startsWith('data: '));

          for (const line of lines) {
            const event = JSON.parse(line.slice(6));
            handleBulkEvent(event, log);

            if (event.type === 'queue') {
              totalTopics = event.total;
            } else if (event.type === 'topic-start') {
              currentIndex = event.index + 1;
              const progress = (currentIndex / totalTopics * 100).toFixed(0);
              document.getElementById('bulk-progress-text').textContent = `${currentIndex} / ${totalTopics}`;
              document.getElementById('bulk-progress-bar').style.width = progress + '%';
            } else if (event.type === 'bulk-complete') {
              document.getElementById('bulk-progress-text').textContent = `Done! ${event.completed}/${event.total} completed`;
              document.getElementById('bulk-close-btn').classList.remove('hidden');
            }
          }
        }
      } catch (error) {
        log.innerHTML += `<div class="text-red-400">Error: ${error.message}</div>`;
        document.getElementById('bulk-close-btn').classList.remove('hidden');
      }
    }

    function handleBulkEvent(event, log) {
      switch (event.type) {
        case 'queue':
          log.innerHTML = `<div class="text-white font-medium">Processing ${event.total} topics...</div>`;
          break;
        case 'topic-start':
          log.innerHTML += `<div class="text-primary-400 mt-2">Starting: ${event.name}</div>`;
          break;
        case 'topic-progress':
          if (event.message) {
            log.innerHTML += `<div class="text-gray-500 text-xs pl-4">${event.message}</div>`;
          }
          break;
        case 'topic-complete':
          log.innerHTML += `<div class="text-green-400">‚úì ${event.name}: +${event.newQuestions} questions (total: ${event.totalQuestions})</div>`;
          break;
        case 'topic-error':
          log.innerHTML += `<div class="text-red-400">‚úó ${event.name}: ${event.error}</div>`;
          break;
        case 'bulk-complete':
          log.innerHTML += `<div class="text-white font-medium mt-3 pt-3 border-t border-gray-700">
            Bulk generation complete!<br>
            <span class="text-green-400">${event.completed} succeeded</span>
            ${event.failed > 0 ? `<span class="text-red-400 ml-2">${event.failed} failed</span>` : ''}
            <br>
            <span class="text-primary-400">+${event.totalNewQuestions} new questions generated</span>
          </div>`;
          break;
      }
      log.scrollTop = log.scrollHeight;
    }

    // Initialize on load
    init();
  </script>
</body>
</html>
