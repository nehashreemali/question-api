<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Question Browser</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #0f172a; }
    .card { background: #1e293b; border: 1px solid #334155; }
    .question-card:hover { border-color: #06b6d4; }
    .difficulty-easy { background: #22c55e20; color: #4ade80; }
    .difficulty-medium { background: #eab30820; color: #facc15; }
    .difficulty-hard { background: #ef444420; color: #f87171; }
  </style>
</head>
<body class="min-h-screen text-gray-100">
  <!-- Navigation -->
  <nav class="bg-slate-800 border-b border-slate-700 px-6 py-4 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
      <h1 class="text-xl font-bold text-white">Question Generator</h1>
      <div class="flex gap-4">
        <a href="/" class="text-gray-400 hover:text-white transition">Generator</a>
        <a href="/stats" class="text-gray-400 hover:text-white transition">Stats</a>
        <a href="/questions" class="text-cyan-400 font-medium">Questions</a>
      </div>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-6 py-8">
    <h2 class="text-3xl font-bold mb-6">Question Browser</h2>

    <!-- Filters -->
    <div class="card rounded-xl p-4 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
        <div>
          <label class="block text-sm text-gray-400 mb-1">Show</label>
          <select id="filter-show" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white">
            <option value="">All Shows</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-gray-400 mb-1">Season</label>
          <select id="filter-season" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white">
            <option value="">All Seasons</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-gray-400 mb-1">Generator</label>
          <select id="filter-generator" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white">
            <option value="">All</option>
            <option value="groq">Groq</option>
            <option value="claude-code">Claude Code</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-gray-400 mb-1">Difficulty</label>
          <select id="filter-difficulty" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white">
            <option value="">All</option>
            <option value="easy">Easy</option>
            <option value="medium">Medium</option>
            <option value="hard">Hard</option>
          </select>
        </div>
        <div class="flex items-end">
          <button id="apply-filters" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-medium py-2 px-4 rounded-lg transition">
            Apply Filters
          </button>
        </div>
      </div>
    </div>

    <!-- Results count -->
    <div class="flex items-center justify-between mb-4">
      <p id="results-count" class="text-gray-400">Loading questions...</p>
      <p id="showing-count" class="text-gray-400"></p>
    </div>

    <!-- Questions List -->
    <div id="questions-list" class="space-y-4">
      <!-- Loading state -->
      <div id="loading" class="text-center py-12">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-400 mx-auto"></div>
      </div>
    </div>

    <!-- Load More -->
    <div id="load-more-container" class="hidden text-center py-8">
      <button id="load-more" class="bg-slate-700 hover:bg-slate-600 text-white font-medium py-3 px-8 rounded-lg transition">
        Load More Questions
      </button>
    </div>

    <!-- End of results -->
    <div id="end-of-results" class="hidden text-center py-8 text-gray-500">
      No more questions to load
    </div>
  </main>

  <script>
    let currentOffset = 0;
    const limit = 50;
    let totalQuestions = 0;
    let isLoading = false;

    // Load shows for filter
    async function loadShows() {
      try {
        const response = await fetch('/api/question-stats');
        const stats = await response.json();

        const showSelect = document.getElementById('filter-show');
        const shows = Object.keys(stats.byShow).sort();

        for (const show of shows) {
          const option = document.createElement('option');
          option.value = show;
          option.textContent = show.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
          showSelect.appendChild(option);
        }
      } catch (error) {
        console.error('Failed to load shows:', error);
      }
    }

    // Update seasons when show changes
    document.getElementById('filter-show').addEventListener('change', function() {
      const seasonSelect = document.getElementById('filter-season');
      seasonSelect.innerHTML = '<option value="">All Seasons</option>';

      if (this.value) {
        // Add seasons 1-10 as options (can be improved with actual data)
        for (let i = 1; i <= 12; i++) {
          const option = document.createElement('option');
          option.value = i;
          option.textContent = `Season ${i}`;
          seasonSelect.appendChild(option);
        }
      }
    });

    function getFilters() {
      return {
        show: document.getElementById('filter-show').value,
        season: document.getElementById('filter-season').value,
        generator: document.getElementById('filter-generator').value,
        difficulty: document.getElementById('filter-difficulty').value,
      };
    }

    function buildQueryString(filters, offset) {
      const params = new URLSearchParams();
      if (filters.show) params.set('show', filters.show);
      if (filters.season) params.set('season', filters.season);
      if (filters.generator) params.set('generator', filters.generator);
      if (filters.difficulty) params.set('difficulty', filters.difficulty);
      params.set('limit', limit);
      params.set('offset', offset);
      return params.toString();
    }

    function createQuestionCard(q, index) {
      const topicInfo = q.topic || {};
      const showName = (topicInfo.show || 'Unknown').replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
      const episodeInfo = topicInfo.season && topicInfo.episode
        ? `S${topicInfo.season}E${topicInfo.episode}`
        : '';

      const difficultyClass = `difficulty-${q.difficulty || 'medium'}`;
      const generatorBadge = q.generatedBy === 'groq'
        ? '<span class="px-2 py-0.5 rounded text-xs bg-emerald-900 text-emerald-300">Groq</span>'
        : q.generatedBy === 'claude-code'
        ? '<span class="px-2 py-0.5 rounded text-xs bg-purple-900 text-purple-300">Claude</span>'
        : '';

      return `
        <div class="question-card card rounded-xl p-5 transition-all duration-200">
          <div class="flex items-start justify-between gap-4 mb-3">
            <div class="flex items-center gap-2 text-sm text-gray-400">
              <span class="font-medium text-cyan-400">${showName}</span>
              ${episodeInfo ? `<span>•</span><span>${episodeInfo}</span>` : ''}
              ${generatorBadge}
            </div>
            <span class="px-2 py-0.5 rounded text-xs ${difficultyClass}">
              ${(q.difficulty || 'medium').charAt(0).toUpperCase() + (q.difficulty || 'medium').slice(1)}
            </span>
          </div>

          <h3 class="text-lg font-medium mb-4">${q.question}</h3>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-4">
            ${q.options.map((opt, i) => {
              const isCorrect = opt === q.correct_answer;
              const bgClass = isCorrect ? 'bg-green-900/30 border-green-600' : 'bg-slate-800 border-slate-600';
              const textClass = isCorrect ? 'text-green-400' : 'text-gray-300';
              return `
                <div class="flex items-center gap-2 p-2 rounded-lg border ${bgClass}">
                  <span class="w-6 h-6 flex items-center justify-center rounded-full bg-slate-700 text-xs font-medium">
                    ${String.fromCharCode(65 + i)}
                  </span>
                  <span class="${textClass}">${opt}</span>
                  ${isCorrect ? '<span class="ml-auto text-green-400">✓</span>' : ''}
                </div>
              `;
            }).join('')}
          </div>

          ${q.explanation ? `
            <div class="text-sm text-gray-400 bg-slate-800 rounded-lg p-3">
              <span class="font-medium text-gray-300">Explanation:</span> ${q.explanation}
            </div>
          ` : ''}
        </div>
      `;
    }

    async function loadQuestions(append = false) {
      if (isLoading) return;
      isLoading = true;

      const filters = getFilters();
      const queryString = buildQueryString(filters, currentOffset);

      try {
        const response = await fetch(`/api/questions-list?${queryString}`);
        const data = await response.json();

        totalQuestions = data.total;

        const listContainer = document.getElementById('questions-list');
        const loadingEl = document.getElementById('loading');
        const loadMoreContainer = document.getElementById('load-more-container');
        const endOfResults = document.getElementById('end-of-results');

        if (!append) {
          listContainer.innerHTML = '';
          currentOffset = 0;
        }

        loadingEl.classList.add('hidden');

        if (data.questions.length === 0 && currentOffset === 0) {
          listContainer.innerHTML = `
            <div class="text-center py-12 text-gray-400">
              <p class="text-xl mb-2">No questions found</p>
              <p>Try adjusting your filters</p>
            </div>
          `;
          loadMoreContainer.classList.add('hidden');
          endOfResults.classList.add('hidden');
        } else {
          for (const q of data.questions) {
            listContainer.insertAdjacentHTML('beforeend', createQuestionCard(q, currentOffset));
            currentOffset++;
          }

          // Update counts
          document.getElementById('results-count').textContent = `${totalQuestions.toLocaleString()} questions found`;
          document.getElementById('showing-count').textContent = `Showing ${currentOffset} of ${totalQuestions}`;

          // Show/hide load more button
          if (currentOffset < totalQuestions) {
            loadMoreContainer.classList.remove('hidden');
            endOfResults.classList.add('hidden');
          } else {
            loadMoreContainer.classList.add('hidden');
            if (totalQuestions > 0) {
              endOfResults.classList.remove('hidden');
            }
          }
        }
      } catch (error) {
        console.error('Failed to load questions:', error);
        document.getElementById('questions-list').innerHTML = `
          <div class="text-center py-12 text-red-400">
            Failed to load questions. Make sure the server is running.
          </div>
        `;
      } finally {
        isLoading = false;
      }
    }

    // Event listeners
    document.getElementById('apply-filters').addEventListener('click', () => {
      currentOffset = 0;
      document.getElementById('loading').classList.remove('hidden');
      loadQuestions(false);
    });

    document.getElementById('load-more').addEventListener('click', () => {
      loadQuestions(true);
    });

    // Infinite scroll
    window.addEventListener('scroll', () => {
      if (isLoading) return;

      const scrollY = window.scrollY;
      const visible = document.documentElement.clientHeight;
      const pageHeight = document.documentElement.scrollHeight;
      const bottomOfPage = visible + scrollY >= pageHeight - 500;

      if (bottomOfPage && currentOffset < totalQuestions) {
        loadQuestions(true);
      }
    });

    // Initial load
    loadShows();
    loadQuestions();
  </script>
</body>
</html>
