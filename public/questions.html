<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Question Browser</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { height: 100%; overflow: hidden; background: #0f172a; }
    .card { background: #1e293b; border: 1px solid #334155; }
    .question-card:hover { border-color: #06b6d4; }
    .difficulty-easy { background: #22c55e20; color: #4ade80; }
    .difficulty-medium { background: #eab30820; color: #facc15; }
    .difficulty-hard { background: #ef444420; color: #f87171; }
    .modal-backdrop { background: rgba(0, 0, 0, 0.7); }
  </style>
</head>
<body class="h-screen flex flex-col text-gray-100">
  <!-- Navigation -->
  <nav class="bg-slate-800 border-b border-slate-700 px-6 py-4 flex-shrink-0">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-6">
        <h1 class="text-xl font-bold text-white">Question API</h1>
        <span id="results-count" class="text-gray-400 text-sm">Loading...</span>
      </div>
      <div class="flex items-center gap-4">
        <button id="open-filters" class="flex items-center gap-2 bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg transition">
          <span>Filters</span>
          <span id="active-filter-count" class="hidden bg-cyan-500 text-xs px-2 py-0.5 rounded-full">0</span>
        </button>
        <div class="flex gap-4">
          <a href="/" class="text-gray-400 hover:text-white transition">Home</a>
          <a href="/stats" class="text-gray-400 hover:text-white transition">Stats</a>
          <a href="/questions" class="text-cyan-400 font-medium">Questions</a>
          <a href="/registry" class="text-gray-400 hover:text-white transition">Registry</a>
          <a href="/pipeline" class="text-gray-400 hover:text-white transition">Pipeline</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Scrollable Questions List -->
  <main class="flex-1 overflow-y-auto">
    <div class="max-w-5xl mx-auto px-6 py-6">
      <div id="questions-list" class="space-y-4">
        <!-- Loading state -->
        <div id="loading" class="text-center py-12">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-400 mx-auto"></div>
        </div>
      </div>

      <!-- Load More -->
      <div id="load-more-container" class="hidden text-center py-8">
        <button id="load-more" class="bg-slate-700 hover:bg-slate-600 text-white font-medium py-3 px-8 rounded-lg transition">
          Load More Questions
        </button>
      </div>

      <!-- End of results -->
      <div id="end-of-results" class="hidden text-center py-8 text-gray-500">
        No more questions to load
      </div>
    </div>
  </main>

  <!-- Filter Modal -->
  <div id="filter-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
    <div class="card rounded-xl p-6 w-full max-w-md mx-4 shadow-2xl">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-semibold">Filter Questions</h3>
        <button id="close-filters" class="text-gray-400 hover:text-white text-2xl">&times;</button>
      </div>

      <div class="space-y-4">
        <div>
          <label class="block text-sm text-gray-400 mb-1">Show</label>
          <select id="filter-show" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white">
            <option value="">All Shows</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-gray-400 mb-1">Season</label>
          <select id="filter-season" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white">
            <option value="">All Seasons</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-gray-400 mb-1">Difficulty</label>
          <select id="filter-difficulty" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white">
            <option value="">All</option>
            <option value="easy">Easy</option>
            <option value="medium">Medium</option>
            <option value="hard">Hard</option>
          </select>
        </div>
      </div>

      <div class="flex gap-3 mt-6">
        <button id="clear-filters" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-medium py-2 px-4 rounded-lg transition">
          Clear
        </button>
        <button id="apply-filters" class="flex-1 bg-cyan-600 hover:bg-cyan-500 text-white font-medium py-2 px-4 rounded-lg transition">
          Apply Filters
        </button>
      </div>
    </div>
  </div>

  <script>
    let currentOffset = 0;
    const limit = 50;
    let totalQuestions = 0;
    let isLoading = false;

    const modal = document.getElementById('filter-modal');
    const mainContent = document.querySelector('main');

    // Modal controls
    document.getElementById('open-filters').addEventListener('click', () => {
      modal.classList.remove('hidden');
    });

    document.getElementById('close-filters').addEventListener('click', () => {
      modal.classList.add('hidden');
    });

    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.classList.add('hidden');
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') modal.classList.add('hidden');
    });

    // Load shows for filter
    async function loadShows() {
      try {
        const response = await fetch('/api/tv-shows');
        const shows = await response.json();

        const showSelect = document.getElementById('filter-show');

        for (const show of shows) {
          const option = document.createElement('option');
          option.value = show.slug;
          option.textContent = show.name;
          showSelect.appendChild(option);
        }
      } catch (error) {
        console.error('Failed to load shows:', error);
      }
    }

    // Update seasons when show changes
    document.getElementById('filter-show').addEventListener('change', function() {
      const seasonSelect = document.getElementById('filter-season');
      seasonSelect.innerHTML = '<option value="">All Seasons</option>';

      if (this.value) {
        for (let i = 1; i <= 12; i++) {
          const option = document.createElement('option');
          option.value = i;
          option.textContent = `Season ${i}`;
          seasonSelect.appendChild(option);
        }
      }
    });

    function getFilters() {
      return {
        show: document.getElementById('filter-show').value,
        season: document.getElementById('filter-season').value,
        difficulty: document.getElementById('filter-difficulty').value,
      };
    }

    function updateFilterBadge() {
      const filters = getFilters();
      const count = [filters.show, filters.season, filters.difficulty].filter(Boolean).length;
      const badge = document.getElementById('active-filter-count');
      if (count > 0) {
        badge.textContent = count;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }

    function buildQueryString(filters, offset) {
      const params = new URLSearchParams();
      if (filters.show) params.set('show', filters.show);
      if (filters.season) params.set('season', filters.season);
      if (filters.difficulty) params.set('difficulty', filters.difficulty);
      params.set('limit', limit);
      params.set('offset', offset);
      return params.toString();
    }

    function createQuestionCard(q, index) {
      const topicInfo = q.topic || {};
      const showName = (topicInfo.show || 'Unknown').replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
      const episodeInfo = topicInfo.season && topicInfo.episode
        ? `S${topicInfo.season}E${topicInfo.episode}`
        : '';

      const difficultyClass = `difficulty-${q.difficulty || 'medium'}`;

      return `
        <div class="question-card card rounded-xl p-5 transition-all duration-200">
          <div class="flex items-start justify-between gap-4 mb-3">
            <div class="flex items-center gap-2 text-sm text-gray-400">
              <span class="font-medium text-cyan-400">${showName}</span>
              ${episodeInfo ? `<span>•</span><span>${episodeInfo}</span>` : ''}
            </div>
            <span class="px-2 py-0.5 rounded text-xs ${difficultyClass}">
              ${(q.difficulty || 'medium').charAt(0).toUpperCase() + (q.difficulty || 'medium').slice(1)}
            </span>
          </div>

          <h3 class="text-lg font-medium mb-4">${q.question}</h3>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-4">
            ${q.options.map((opt, i) => {
              const isCorrect = opt === q.correct_answer;
              const bgClass = isCorrect ? 'bg-green-900/30 border-green-600' : 'bg-slate-800 border-slate-600';
              const textClass = isCorrect ? 'text-green-400' : 'text-gray-300';
              return `
                <div class="flex items-center gap-2 p-2 rounded-lg border ${bgClass}">
                  <span class="w-6 h-6 flex items-center justify-center rounded-full bg-slate-700 text-xs font-medium">
                    ${String.fromCharCode(65 + i)}
                  </span>
                  <span class="${textClass}">${opt}</span>
                  ${isCorrect ? '<span class="ml-auto text-green-400">✓</span>' : ''}
                </div>
              `;
            }).join('')}
          </div>

          ${q.explanation ? `
            <div class="text-sm text-gray-400 bg-slate-800 rounded-lg p-3">
              <span class="font-medium text-gray-300">Explanation:</span> ${q.explanation}
            </div>
          ` : ''}
        </div>
      `;
    }

    async function loadQuestions(append = false) {
      if (isLoading) return;
      isLoading = true;

      const filters = getFilters();
      const queryString = buildQueryString(filters, currentOffset);

      try {
        const response = await fetch(`/api/questions?${queryString}`);
        const data = await response.json();

        totalQuestions = data.total;

        const listContainer = document.getElementById('questions-list');
        const loadingEl = document.getElementById('loading');
        const loadMoreContainer = document.getElementById('load-more-container');
        const endOfResults = document.getElementById('end-of-results');

        if (!append) {
          listContainer.innerHTML = '';
          currentOffset = 0;
        }

        loadingEl.classList.add('hidden');

        if (data.questions.length === 0 && currentOffset === 0) {
          listContainer.innerHTML = `
            <div class="text-center py-12 text-gray-400">
              <p class="text-xl mb-2">No questions found</p>
              <p>Try adjusting your filters</p>
            </div>
          `;
          loadMoreContainer.classList.add('hidden');
          endOfResults.classList.add('hidden');
        } else {
          for (const q of data.questions) {
            listContainer.insertAdjacentHTML('beforeend', createQuestionCard(q, currentOffset));
            currentOffset++;
          }

          // Update counts
          document.getElementById('results-count').textContent = `${totalQuestions.toLocaleString()} questions`;

          // Show/hide load more button
          if (currentOffset < totalQuestions) {
            loadMoreContainer.classList.remove('hidden');
            endOfResults.classList.add('hidden');
          } else {
            loadMoreContainer.classList.add('hidden');
            if (totalQuestions > 0) {
              endOfResults.classList.remove('hidden');
            }
          }
        }
      } catch (error) {
        console.error('Failed to load questions:', error);
        document.getElementById('questions-list').innerHTML = `
          <div class="text-center py-12 text-red-400">
            Failed to load questions. Make sure the server is running.
          </div>
        `;
      } finally {
        isLoading = false;
      }
    }

    // Apply filters
    document.getElementById('apply-filters').addEventListener('click', () => {
      modal.classList.add('hidden');
      currentOffset = 0;
      updateFilterBadge();
      document.getElementById('questions-list').innerHTML = `
        <div id="loading" class="text-center py-12">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-400 mx-auto"></div>
        </div>
      `;
      loadQuestions(false);
    });

    // Clear filters
    document.getElementById('clear-filters').addEventListener('click', () => {
      document.getElementById('filter-show').value = '';
      document.getElementById('filter-season').value = '';
      document.getElementById('filter-difficulty').value = '';
      document.getElementById('filter-season').innerHTML = '<option value="">All Seasons</option>';
    });

    document.getElementById('load-more').addEventListener('click', () => {
      loadQuestions(true);
    });

    // Infinite scroll on main content
    mainContent.addEventListener('scroll', () => {
      if (isLoading) return;

      const scrollTop = mainContent.scrollTop;
      const scrollHeight = mainContent.scrollHeight;
      const clientHeight = mainContent.clientHeight;
      const nearBottom = scrollTop + clientHeight >= scrollHeight - 300;

      if (nearBottom && currentOffset < totalQuestions) {
        loadQuestions(true);
      }
    });

    // Initial load
    loadShows();
    loadQuestions();
  </script>
</body>
</html>
